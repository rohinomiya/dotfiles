# -*- ruby -*-
require 'autotest/growl'

Autotest.add_discovery { "rspec2" }
#  Autotest.add_discovery { "rspec" }

# ./foo.rb が更新されると ./spec/foo_spec.rb が走る。
Autotest.add_hook :initialize do |at|
  at.add_exception %r{^\.log}
  at.add_exception %r{^\.git}  # ignore Version Control System
  at.add_exception %r{^./tmp}  # ignore temp files, lest autotest will run again, and again...

  at.add_mapping(/([\w\d_]+)\.rb$/) {|f, matched|
    "spec/#{matched[1]}_spec.rb"
  }
end

# 何故か２重にポップアップが表示されてうざいので、適当にクリアーした
class Autotest
  def self.clear_hook
    HOOKS[:red].clear
    HOOKS[:green].clear
    HOOKS[:all_good].clear
  end
end
Autotest.clear_hook

ICON_FAILURE = "rails_fail"
ICON_SUCCESS = "rails_ok"

module Autotest::Growl
  Autotest.add_hook :ran_command do |at|
    result = [at.results].flatten.join("\n")
    examples = result.slice(/(\d+)\s+examples?/).to_i
    tests = result.slice(/(\d+)\s+tests?/).to_i
    failures = result.slice(/(\d+)\s+failures?/).to_i
    errors = result.slice(/(\d+)\s+failures?/).to_i
    if examples >= 0
      if failures > 0 || errors > 0
        growl "Tests Failed", "#{failures} failures #{errors} errors",ICON_FAILURE, 2 #, true
      else
        growl "Tests Passed", "#{tests + examples} tests",ICON_SUCCESS, -2
      end
    else
      growl "Tests Error", "Some ploblem occurred.",ICON_FAILURE, 2, true
    end
  end
end

